<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home | Interview Confidence Analyzer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .navbar {
            animation: fadeInDown 0.8s ease-out;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }

        .navbar-brand:hover {
            transform: scale(1.05);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            padding: 60px 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            animation: fadeInDown 1s ease-out;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header p {
            animation: fadeInUp 1s ease-out 0.3s both;
            text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.2);
        }

        .container {
            position: relative;
            z-index: 1;
        }

        .profile-card {
            background-color: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            animation: fadeInUp 0.8s ease-out;
            border: 1px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .profile-card h5 {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }

        .profile-card p {
            padding: 8px 0;
            margin: 0;
        }

        .profile-card span {
            font-size: 0.95rem;
            color: #555;
            font-weight: 600;
        }

        .upload-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .method-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .method-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
        }

        .method-card h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .method-card p {
            color: #666;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        #livePreview {
            width: 100%;
            height: auto;
            border-radius: 15px;
            display: block;
            background: #000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: scaleX(-1);
        }

        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            z-index: 10;
            display: none;
        }

        .video-label.recording {
            display: block;
            animation: blink 0.9s infinite;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin: 10px 0;
            font-size: 0.95rem;
        }

        .status-ready {
            background-color: #d4edda;
            color: #155724;
        }

        .status-recording {
            background-color: #f8d7da;
            color: #721c24;
            animation: blink 0.9s infinite;
        }

        .status-processing {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            width: 100%;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(17, 153, 142, 0.6);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(245, 87, 108, 0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .spinner-border {
            animation: spin 1s linear infinite;
            width: 3rem;
            height: 3rem;
            border-width: 0.3em;
            margin: 20px auto;
        }

        .form-control {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 12px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .alert {
            border-radius: 12px;
            margin: 15px 0;
            border: none;
        }

        #liveRecordingSection {
            animation: fadeInUp 0.8s ease-out;
        }

        .results-section {
            background-color: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            animation: fadeInUp 0.8s ease-out;
            margin-top: 20px;
        }

        .table {
            border-radius: 12px;
            overflow: hidden;
            margin-top: 20px;
        }

        .table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .table tbody tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        #overall-confidence {
            color: #667eea;
            font-weight: 700;
            font-size: 2rem;
        }

        @media (max-width: 768px) {
            .header {
                padding: 40px 15px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .profile-card {
                padding: 20px;
            }

            .upload-methods {
                grid-template-columns: 1fr;
            }

            #livePreview {
                max-width: 100%;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    
<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand fw-bold" href="index.html">Interview Analyzer</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link active" href="{% url 'home' %}">Home</a></li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'candidate_history' %}">History Tracker</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'report_generator_self' %}">Report Generator</a>
                </li>
                <li class="nav-item"><a class="nav-link btn btn-danger btn-sm ms-2 text-white" href="{% url 'logout' %}">Logout</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="header">
    <h1 class="display-5 fw-bold">AI-Based Interview Confidence Analyzer</h1>
    <p class="lead">Upload your interview video or record live to receive AI-driven insights on your confidence level, expressions, and communication style.</p>
</div>

<div class="container mt-5 mb-5">

    <!-- Profile Information -->
    <div class="profile-card">
        <h5>üìã Candidate Profile</h5>
        <p><strong>Name:</strong> <span id="userName">{{ request.session.user_name|default:"Guest" }}</span></p>
        <p><strong>Email:</strong> <span id="userEmail">{{ request.session.user_email|default:"Not Logged In" }}</span></p>
        <p><strong>Role:</strong> <span id="userRole">{{ request.session.user_role|default:"N/A" }}</span></p>
        <p><strong>Last Login:</strong> <span id="userLogin">{% now "d-M-Y H:i A" %}</span></p>
    </div>

    <!-- Upload Methods Section -->
    <div class="upload-methods">
        <!-- Method 1: Upload Video File -->
        <div class="method-card">
            <h4>üì§ Upload Video File</h4>
            <p>Choose a pre-recorded interview video from your device</p>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <input type="file" class="form-control" id="videoFile" name="videoFile" accept="video/*" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Analyze Video</button>
            </form>
        </div>

        <!-- Method 2: Live Recording -->
        <div class="method-card">
            <h4>üé• Live Recording</h4>
            <p>Record your interview in real-time using your webcam</p>
            <div id="liveStatus" class="mb-3 text-primary">‚úì Camera Ready</div>
            <button id="startLiveBtn" class="btn btn-success w-100 mb-2">Start Live Recording</button>
            <button id="stopLiveBtn" class="btn btn-danger w-100" disabled>Stop & Analyze</button>
        </div>
    </div>

    <!-- Live Preview Video (Hidden by default) -->
    <div id="liveRecordingSection" style="display: none;">
        <div class="results-section text-center">
            <h4 class="mb-3">üî¥ Live Interview Recording</h4>
            <div class="video-container">
                <video id="livePreview" autoplay muted playsinline></video>
                <div id="recordingLabel" class="video-label">‚óè RECORDING</div>
            </div>
            <div>
                <span id="statusBadge" class="status-badge status-ready">‚úì Ready to Record</span>
            </div>
        </div>
    </div>

    <!-- Loading Message -->
    <div id="loadingMessage" class="text-center mt-3 text-primary" style="display: none;">
        <div class="spinner-border text-primary" role="status"></div>
        <p>Processing your video, please wait...</p>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" style="display: none;"></div>

    <!-- Results -->
    <div id="results" class="results-section" style="display: none;">
        <h3 class="mb-4 text-center">üìã Your Confidence Analysis</h3>
        <table class="table table-bordered text-center">
            <thead class="table-light">
                <tr>
                    <th>Aspect</th>
                    <th>Confidence (%)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Facial Expressions</td>
                    <td id="expression-confidence"></td>
                </tr>
                <tr>
                    <td>Eye Movement</td>
                    <td id="eye-confidence"></td>
                </tr>
                <tr>
                    <td>Speech Analysis</td>
                    <td id="speech-confidence"></td>
                </tr>
                <tr>
                    <td>Hand Gestures</td>
                    <td id="hand-confidence"></td>
                </tr>
            </tbody>
        </table>
        <h4 class="text-center mt-4">üß† Overall Confidence Score: <span id="overall-confidence"></span>%</h4>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// =======================================================
// üé• LIVE RECORDING FUNCTIONALITY
// =======================================================
let mediaRecorder;
let recordedChunks = [];
let liveStream = null;

const livePreview = document.getElementById("livePreview");
const liveStatus = document.getElementById("liveStatus");
const statusBadge = document.getElementById("statusBadge");
const recordingLabel = document.getElementById("recordingLabel");
const startLiveBtn = document.getElementById("startLiveBtn");
const stopLiveBtn = document.getElementById("stopLiveBtn");
const liveRecordingSection = document.getElementById("liveRecordingSection");
const loadingMessage = document.getElementById("loadingMessage");
const results = document.getElementById("results");
const errorMessage = document.getElementById("errorMessage");

function showError(message) {
    errorMessage.innerHTML = `<div class="alert alert-danger" role="alert"><strong>Error:</strong> ${message}</div>`;
    errorMessage.style.display = "block";
}

function updateStatus(status, className) {
    statusBadge.textContent = status;
    statusBadge.className = `status-badge ${className}`;
}

// Start Live Recording
startLiveBtn.addEventListener("click", async () => {
    try {
        liveStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }, 
            audio: true
        });
        
        livePreview.srcObject = liveStream;
        liveRecordingSection.style.display = "block";

        const mimeType = MediaRecorder.isTypeSupported('video/webm') 
            ? 'video/webm' 
            : 'video/mp4';
        
        mediaRecorder = new MediaRecorder(liveStream, { mimeType: mimeType });

        recordedChunks = [];

        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };

        mediaRecorder.onstop = () => {
            uploadLiveRecording();
        };

        mediaRecorder.start();

        startLiveBtn.disabled = true;
        stopLiveBtn.disabled = false;

        liveStatus.innerHTML = "üî¥ Recording...";
        liveStatus.classList.add("recording");
        recordingLabel.classList.add("recording");
        updateStatus("üî¥ Recording in progress...", "status-recording");

    } catch (err) {
        console.error(err);
        const errorMsg = err.name === 'NotAllowedError' 
            ? "Camera access was denied. Please check your browser permissions."
            : "Error accessing camera: " + err.message;
        
        showError(errorMsg);
        liveStatus.innerHTML = "‚ùå Camera access denied";
    }
});

// Stop Live Recording
stopLiveBtn.addEventListener("click", () => {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        
        if (liveStream) {
            liveStream.getTracks().forEach(track => track.stop());
        }

        stopLiveBtn.disabled = true;
        liveStatus.classList.remove("recording");
        recordingLabel.classList.remove("recording");
        liveStatus.innerHTML = "‚è≥ Processing & Uploading...";
        updateStatus("‚è≥ Processing...", "status-processing");
    }
});

// Upload Live Recording
function uploadLiveRecording() {
    const blob = new Blob(recordedChunks, { type: "video/webm" });
    const formData = new FormData();
    formData.append("video", blob, "live_recording.webm");

    loadingMessage.style.display = "block";
    errorMessage.style.display = "none";

    const userId = "{{ request.session.user_id }}";

    fetch(`/save-candidate-live-recording/${userId}/`, {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        loadingMessage.style.display = "none";
        
        if (data.success) {
            displayResults(data.confidence_result);
            liveStatus.innerHTML = "‚úÖ Analysis Complete!";
            updateStatus("‚úÖ Analysis Complete!", "status-ready");
            
            setTimeout(() => {
                startLiveBtn.disabled = false;
                stopLiveBtn.disabled = true;
                liveRecordingSection.style.display = "none";
            }, 2000);
        } else {
            showError(data.error || "Unknown error occurred");
            liveStatus.innerHTML = "‚ùå Error occurred";
            startLiveBtn.disabled = false;
            stopLiveBtn.disabled = true;
        }
    })
    .catch(error => {
        loadingMessage.style.display = "none";
        showError("Upload failed: " + error.message);
        console.error(error);
        liveStatus.innerHTML = "‚ùå Upload failed";
        startLiveBtn.disabled = false;
        stopLiveBtn.disabled = true;
    });
}

// =======================================================
// üì§ FILE UPLOAD FUNCTIONALITY
// =======================================================
document.getElementById("uploadForm").addEventListener("submit", function(event) {
    event.preventDefault();

    let formData = new FormData();
    let fileInput = document.getElementById("videoFile");
    
    if (!fileInput.files[0]) {
        showError("Please select a video file first!");
        return;
    }
    
    formData.append("video", fileInput.files[0]);

    loadingMessage.style.display = "block";
    results.style.display = "none";
    errorMessage.style.display = "none";

    fetch("upload_video", {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        loadingMessage.style.display = "none";
        
        if (data.confidence_result) {
            displayResults(data.confidence_result);
        } else if (data.error) {
            showError(data.error);
        }
    })
    .catch(error => {
        loadingMessage.style.display = "none";
        showError("Error processing video. Please try again.");
        console.error(error);
    });
});

// =======================================================
// üìä DISPLAY RESULTS FUNCTION
// =======================================================
function displayResults(result) {
    results.style.display = "block";
    window.scrollTo(0, results.offsetTop - 100);

    document.getElementById("expression-confidence").innerText = result.expression_confidence.toFixed(2) + "%";
    document.getElementById("eye-confidence").innerText = result.eye_movement_confidence.toFixed(2) + "%";
    document.getElementById("speech-confidence").innerText = result.speech_confidence.toFixed(2) + "%";
    document.getElementById("hand-confidence").innerText = result.hand_gesture_confidence.toFixed(2) + "%";
    document.getElementById("overall-confidence").innerText = result.overall_confidence.toFixed(2);
}
</script>

</body>
</html>